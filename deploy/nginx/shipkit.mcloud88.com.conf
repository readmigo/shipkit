# ShipKit — Nginx reverse proxy
#
# Cloudflare handles SSL termination, so this server block listens on port 80.
# Copy to /etc/nginx/sites-available/ and symlink to sites-enabled/.
#
# Installation:
#   sudo cp shipkit.mcloud88.com.conf /etc/nginx/sites-available/
#   sudo ln -s /etc/nginx/sites-available/shipkit.mcloud88.com.conf /etc/nginx/sites-enabled/
#   sudo nginx -t && sudo systemctl reload nginx

server {
    listen 80;
    server_name shipkit.mcloud88.com;

    # Cloudflare real IP restoration
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 131.0.72.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    real_ip_header CF-Connecting-IP;

    # ── MCP HTTP Transport (SSE) ──────────────────────────────────────
    # SSE streams must not be buffered; keep connection alive.
    location /mcp {
        proxy_pass http://127.0.0.1:3456;
        proxy_http_version 1.1;

        # Disable buffering for SSE
        proxy_buffering off;
        proxy_cache off;

        # SSE / long-lived connection headers
        proxy_set_header Connection '';
        proxy_set_header X-Accel-Buffering no;

        # Increase timeouts for long-lived SSE streams
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;

        # Forward client info
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ── Dashboard + REST API ──────────────────────────────────────────
    location / {
        proxy_pass http://127.0.0.1:3456;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket upgrade (optional, future-proof)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ── Health check for monitoring ───────────────────────────────────
    location /api/health {
        proxy_pass http://127.0.0.1:3456;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }
}
